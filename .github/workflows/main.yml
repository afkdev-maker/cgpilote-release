name: Cleanup Old Releases and Tags

on:
  workflow_dispatch:
    inputs:
      keep:
        description: "Number of newest releases to keep"
        required: true
        default: "5"

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete old releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP: ${{ github.event.inputs.keep }}
        run: |
          echo "Keeping the newest $KEEP releases..."

          releases=$(gh release list --limit 100 | awk '{print $1}')
          count=$(echo "$releases" | wc -l)
          echo "Total releases: $count"

          index=0
          echo "$releases" | while read tag
          do
            index=$((index + 1))
            if [ $index -le $KEEP ]; then
              echo "Keeping release: $tag"
              continue
            fi

            echo "Deleting release: $tag"
            gh release delete "$tag" --yes || true

            echo "Deleting associated tag: $tag"
            git push origin ":refs/tags/$tag" || true
          done

      - name: Delete tags that are not linked to releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deleting tags not associated with any release..."

          # Get all release tags
          release_tags=$(gh release list --limit 1000 | awk '{print $1}')

          # Get all tags in the repository
          all_tags=$(git ls-remote --tags origin | awk '{print $2}' | sed 's|refs/tags/||')

          for tag in $all_tags; do
            if echo "$release_tags" | grep -qx "$tag"; then
              echo "Keeping release tag: $tag"
            else
              echo "Deleting non-release tag: $tag"
              git push origin ":refs/tags/$tag" || true
            fi
          done
