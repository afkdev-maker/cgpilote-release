name: Clean Old Releases and Tags

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Run weekly on Sundays at midnight

jobs:
  clean:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Clean old releases and orphaned tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          echo "=== Step 1: Clean Old Releases (Keep Latest 1) ==="
          
          # Get all release tags
          all_releases=$(gh release list --limit 1000 --json tagName --jq '.[].tagName')
          total=$(echo "$all_releases" | wc -l)
          
          echo "Total releases: $total"
          
          if [ "$total" -gt 1 ]; then
            # Skip first (latest) and delete the rest
            echo "$all_releases" | tail -n +2 | while read -r tag; do
              echo "Deleting release: $tag"
              gh release delete "$tag" --yes
              echo "✓ Deleted: $tag"
            done
          else
            echo "Only 1 or fewer releases found, nothing to delete"
          fi
          
          echo ""
          echo "=== Step 2: Clean Orphaned Tags ==="
          
          # Get remaining release tags
          release_tags=$(gh release list --limit 1000 --json tagName --jq '.[].tagName')
          
          echo "Protected tags (have releases):"
          echo "$release_tags"
          echo ""
          
          # Delete tags that don't have releases
          git tag | while read -r tag; do
            if ! echo "$release_tags" | grep -q "^${tag}$"; then
              echo "Deleting orphaned tag: $tag"
              git push origin --delete "$tag" || echo "Failed to delete $tag"
            fi
          done
          
          echo "✓ Cleanup complete!"
