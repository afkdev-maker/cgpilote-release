name: Cleanup Old Releases and Tags (Safe)

on:
  workflow_dispatch:
    inputs:
      keep:
        description: "Number of newest releases to keep"
        required: true
        default: "1"

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get releases sorted safely
        id: get_releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Capture releases as JSON sorted by creation date (newest first)
          gh release list --limit 200 --json tagName,createdAt \
            --sort createdAt --order desc > releases.json

          echo "Releases sorted by newest first:"
          cat releases.json

      - name: Delete old releases and their tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP: ${{ github.event.inputs.keep }}
        run: |
          keep="$KEEP"

          # Extract sorted tags
          tags=( $(jq -r '.[].tagName' releases.json) )

          echo "Found ${#tags[@]} releases total."
          echo "Will keep the newest $keep release(s)."

          index=0
          for tag in "${tags[@]}"; do
            index=$((index + 1))
            if [ "$index" -le "$keep" ]; then
              echo "Keeping release: $tag"
              continue
            fi

            echo "Deleting old release: $tag"
            gh release delete "$tag" --yes || echo "Failed to delete release $tag"

            echo "Deleting tag: $tag"
            git push origin ":refs/tags/$tag" || echo "Failed to delete tag $tag"
          done

      - name: Delete tags not associated with any release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_tags=$(jq -r '.[].tagName' releases.json)
          all_tags=$(git ls-remote --tags origin | awk '{print $2}' | sed 's|refs/tags/||')

          for tag in $all_tags; do
            if echo "$release_tags" | grep -qx "$tag"; then
              echo "Keeping release tag: $tag"
            else
              echo "Deleting orphaned tag: $tag"
              git push origin ":refs/tags/$tag" || echo "Failed to delete tag $tag"
            fi
          done
